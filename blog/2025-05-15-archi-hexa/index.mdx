---
slug: archi-hexa
title: DDD, architecture hexagonale et hive pattern
authors: [adelegue]
tags: [patterns, ddd]
---

# DDD, architecture hexagonale et hive pattern

Cela fait quelques ann√©es d√©j√† que je m'int√©resse au DDD mais j'ai toujours l'impression d'√™tre un d√©butant.
M√™me si j'utilise certains outils du DDD r√©guli√®rement dans mon travail, je ne me sens pas vraiment l√©gitime √† me consid√©rer comme un pratiquant averti.

Dans notre √©quipe, nous g√©rons un "r√©f√©rentiel de personnes", comme √ßa, √ßa ne sonne pas trop DDD. Et justement, nos use cases, m'ont amen√©s pleins de questions et d'interrogations sur la fa√ßon d'aborder certaines probl√©matiques √† travers les concepts DDD.

{/* truncate */}

## L'instant musical

## Notre (nos) domaine(s)

√Ä la MAIF, la connaissance de la personne et la relation client, c'est vraiment un sujet au premier plan.
Dans notre √©quipe, nous g√©rons un r√©f√©rentiel de personnes, dans lequel, on va stocker tout un tas de donn√©es qui font qu'un conseiller aura une bonne vision du soci√©taire ou du client lorsqu'il devra int√©ragir avec lui.

On va y trouver :
* L'individu lui-m√™me : son nom, pr√©nom, civilit√©, t√©l√©phone, email, etc.
* Son foyer : permet d'avoir l'adresse de contact ainsi que des infos sur les membres de la famille (qui sont des individus) qui pourraient √™tre couvert, car dans le m√™me foyer.
* Les notions de repr√©sentation (tutelle, curatelle, habilitation familiale, succession) : en effet dans le cas d'une repr√©sentation, il faut int√©ragir avec le repr√©sentant.
* Les entit√©s juridiques : Association et collectivit√©, les auto entrepreneurs, etc. Ces structures ont des interlocuteurs qui sont des individus.

Ici, on s'approche un peu du god mod√®le et on s'√©loigne des principes DDD. L'individu est omnipr√©sent dans plusieurs contextes diff√©rents : foyer, entit√©s juridiques, repr√©sentation.

Il y a un moment, j'avais vu le talk de Gr√©gory Weinbach ["Il n'y a pas de bon mod√®le m√©tier"](https://www.youtube.com/watch?v=qN43Dy6fGkk) avec l'exemple du livre dans plusieurs contextes :
* du point de vue de l'auteur : une histoire, un nombre de pages, etc.
* du point de vue de l'imprimeur : un grammage, une police de caract√®res, etc.
* du point de vue du vendeur : un prix, un poids, etc.

Dans notre cas, est-ce que l'individu ne concentre pas trop de facette ? Quel est vraiment notre m√©tier ? Notre domaine ?

Un point important, c'est que du point de vue des utilisateurs, les m√™mes conseillers peuvent travailler sur toutes les typologies de donn√©es.
Un m√™me conseiller peut g√©rer le dossier d'un individu dont l'assurance couvre les membres de son foyer puis,
passer sur le dossier d'un auto-entrepreneur puis,
passer sur le dossier de quelqu'un qui serait repr√©sent√© par un autre individu ou pas une association comme l'UDAF.

C'est probablement le point qui me rassure le plus, vu que notre domaine est probablement un peu trop gros.

### La connaissance de la personne

√Ä l'unanimit√© dans notre √©quipe, ce qui d√©finit notre domaine, ce sont les donn√©es de connaissance de la personne. On ne g√®re pas une adresse de lieu de risque, mais une adresse de contact. On ne g√®re pas email de login, mais un email de contact, etc.

Ces donn√©es √©taient stock√©es dans un CRM du march√©, nous sommes en train de prendre la main dessus au fur et √† mesure, p√©rim√®tre de donn√©es, apr√®s p√©rim√®tres de donn√©es. Au d√©part, nous avions une approche tr√®s CRUD, celle qui nous permettait facilement de r√©pliquer les donn√©es d'un syst√®me √† l'autre.
Au fur et √† mesure qu'on prend la main sur un p√©rim√®tre, on introduit du m√©tier et un cycle de vie de la donn√©e.

On a d√©fini 4 domaines :
* Les individus
* Les foyers avec leurs membres
* Les entit√©s juridiques
* Les liens : lien de repr√©sentation, lien interlocuteur, lien de liquidation judiciaire, lien de soci√©t√© m√®re

Est-ce qu'on peut consid√©rer l'individu, le foyer, l'entit√© juridique et les liens sont des agr√©gats ? Je ne sais pas encore...

## L'architecture logicielle

Depuis le d√©part, on a mis en place une architecture hexagonale. Perso, je ne suis pas trop √† cheval sur le fait de respecter un pattern "by the book".
J'essaye plut√¥t de voir les probl√®mes que le pattern va r√©soudre et je vais ensuite m'approprier ce pattern et l'adapter √† mon contexte. C'est un peu une fa√ßon nice de dire que c'est fait √† l'arrache üòÖ.

Une discussion qui revient souvent, c'est le domaine doit-il √™tre en java vanilla ? Est-ce que des frameworks peuvent transparaitre dans le domaine ?

Dans notre codebase, on utilise des frameworks reactifs, [wrapp√© dans un truc √† nous](https://github.com/larousso/spring-reactif-code-metier), et donc √ßa devient visible dans toutes les signatures des m√©thodes du domaine. Pour le moment, on vit avec.
Par contre, tout ce qui est li√© √† la s√©rialisation json sera dans la partie infra, la config spring aussi.

Nous avons donc 4 hexagones, un pour chaque domaine : individus, foyers, entit√©s juridiques et les liens. Les liens, c'est un peu le four tout, en r√©alit√© chaque lien est un domaine distinct.
Au niveau des ports, chaque hexagone a un port pour int√©ragir avec le stockage, et dans certain cas, on a des ports utilis√©s pour certaines r√®gles de gestion.

Par exemple, si on doit cr√©er un foyer avec des membres, on va v√©rifier que le membre existe bien :

```mermaid
flowchart LR
    F{{
    Domaine
    Foyer
    }}
    SPI1@{ shape: curv-trap, label: "IndividuExiste" }
    SPI2@{ shape: curv-trap, label: "Repo" }
    ADAP1@{ shape: odd, label: "Impl" }
    ADAP2@{ shape: odd, label: "Impl" }
    DB1@{ shape: cyl, label: "Postgresql" }
    DB2@{ shape: cyl, label: "Postgresql" }

    P{{ Domaine
    Individu }}
    PSPI1@{ shape: curv-trap, label: "Repo" }
    PADAP1@{ shape: odd, label: "Impl" }

    F --o SPI1 --> ADAP1 --> P
    F --o SPI2 --> ADAP2 --> DB1
    P --o PSPI1 --> PADAP1 --> DB2
```

Quand on a commenc√© √† prendre le lead sur certains morceaux de donn√©es et √† ne plus seulement √™tre un r√©plica, mais √† devenir maitre de la donn√©e, des backend for frontend ont commenc√© √† nous appeler.
L√† o√π, on avait une approche CRUD pour faire de la replication syst√®me √† syst√®me, on a commenc√© √† int√©grer une vision des choses plus m√©tier et donc √† former de nouveaux regroupements de donn√©es.

Par exemple, pour cr√©er une repr√©sentation de tutelle, il faut cr√©er :
* Le repr√©sentant :
    * Soit une entit√© juridique : par UDAF
    * Soit un individu et son foyer
* Le lien de repr√©sentation

On a donc un nouveau domaine qui apparait avec 2 ports `EntiteJuridiqueRepresantant` et `IndividuRepresantant`

```mermaid
flowchart LR
    R{{
    Domaine
    Repr√©sentant
    }}
    SPI1@{ shape: curv-trap, label: "EntiteJuridiqueRepresantant" }
    SPI2@{ shape: curv-trap, label: "IndividuRepresantant" }
    ADAP1@{ shape: odd, label: "Impl" }
    ADAP2@{ shape: odd, label: "Impl" }

    L{{ Domaine
    Entit√© juridique }}
    P{{ Domaine
    Individu }}
    F{{ Domaine
    Foyer }}

    R --o SPI1 --> ADAP1 --> L
    R --o SPI2 --> ADAP2 --> P
                   ADAP2 --> F
```

Un autre aspect, c'est qu'ici, on passe le contexte transactionnel de bout en bout. On a donc une sorte de nouvel agr√©gat du pauvre.

Au d√©part, nous n'avions pas cr√©√© des nouveaux domaines, juste des m√©thodes suppl√©mentaires dans les domaines existants, c'√©tait un peu le bazar. C'est √† la suite du visionnage du tr√®s bon talk de Thomas Pierrain et Julien Top√ßu sur le hive pattern, qu'on a r√©arrang√© les choses pour clairement faire ressortir les nouveaux domaines.
